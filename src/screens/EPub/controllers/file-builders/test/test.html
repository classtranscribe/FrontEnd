<html>
  <script>
    function test(textHTML, subsMap) {
      let withinTag = false;
      let res = '';

      for (let i = 0; i < textHTML.length; ) {
        if (textHTML[i] == '<') {
          res += textHTML[i];
          withinTag = true;
          i++;
          continue;
        }

        if (textHTML[i] == '>') {
          res += textHTML[i];
          withinTag = false;
          i++;
          continue;
        }

        if (withinTag) {
          res += textHTML[i];
          i++;
          continue;
        }

        let found = false;

        for (const word of Object.keys(subsMap)) {
          if (textHTML.substring(i, i + word.length).localeCompare(word) == 0) {
            res += subsMap[word];
            i += word.length;
            found = true;
            break;
          }
        }

        if (found) {
          continue;
        }

        res += textHTML[i];
        i++;
      }

      console.log(res);
      return res;
    }

    function subsWords(text, subsMap) {
      let res = '';
      mainLoop: for (let i = 0; i < text.length; ) {
        for (const word of Object.keys(subsMap)) {
          if (text.substring(i, i + word.length).localeCompare(word) == 0) {
            res += subsMap[word];
            i += word.length;
            continue mainLoop;
          }
        }
        res += text[i];
        i++;
      }

      return res;
    }

    function subsWordsNode(node, subsMap) {
      const newNode = node.cloneNode();

      for (const child of node.children) {
        newNode.append(subsWordsNode(child, subsMap));
      }

      if(node.innerText) {
        newNode.innerText = subsWords(node.innerText, subsMap);
      }

      console.log(newNode);

      return newNode;
    }

    function subsWordsHTML(text, subsMap) {
      const parser = new DOMParser();
      const dom = parser.parseFromString(text, 'text/html');
      let tmp = document.createElement('div');

      for (let i = 0; i < dom.body.children.length; i++) {
        tmp.append(subsWordsNode(dom.body.children[i], subsMap));
      }

      return tmp.innerHTML;
    }

    const text = subsWordsHTML(
      `<html><body><p>This is a paragraph.</p><p>This is a paragraph.</p><p>This is a paragraph.</p>
<div><p>Taken from wikpedia</p><img src="" alt="Red dot"></img></div></body></html>`,
      {
        paragraph: 'helloworld',
        'is a': 'is_a',
      },
    );

    console.log(text);

  </script>
</html>
